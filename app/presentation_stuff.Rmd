---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
require("knitr")
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "../app/")
knitr::opts_chunk$set(root.dir = "../app/")
# getwd()
# setwd("../app/")
```



```{r}

source("utils.R")
source("simulation.R")
source("country_classification_rules.R")
source("simJourneyPanel.R")
source("defaults.R")
library(ggrepel)
library(DT)

#Ben J:
#Assume 0.5% transmission risk without mask (it’s a conservative worst case rate)
#If mask use reduces risk by 90% as per Arthur’s email then in-flight transmission risk reduced to 0.05%
#Therefore one case expected to be acquired ‘in-flight’ for every 125 infectious cases carried
#default_aircraft_infection_rate <- 0.005 #without mask
#default_aircraft_mask_effectiveness_percent <- 90

#run_date<-as.Date("2020-07-15")#Sys.Date()

month_name <- format(run_date,"%B")


```


```{r}


nogeo_world_basic_data <- get_geomapped_covid_data(life_exp_thresh,run_date,separate_aussie_states_and_hk = TRUE,include_geo_data = FALSE)
default_simulation_data <- simulate_treatment_for_countries(
  nogeo_world_basic_data,
  treatment_effectiveness = default_assumed_effectiveness,
  extra_spread = 0,
  assumed_ifr = default_assumed_ifr_percent/100,
  traveler_relative_prevalence=default_traveler_relative_prevalence,
  current_lockdown_passenger_volume = default_current_lockdown_passenger_volume)
```
```{r}
default_statusquo_simulation_data <- simulate_treatment_for_countries(
  nogeo_world_basic_data,
  treatment_effectiveness = 99.95/100, 
    #should really be 99.9; 99.95 incorporates possiblity of a pre-departure test
    #still, it's "extra spread" that does most of the work here.
  extra_spread = 2.033/100,
  travel_volume_proportion=0,
  assumed_ifr = 0.6/100,
  traveler_relative_prevalence=1.2,
  current_lockdown_passenger_volume = 9037)
```

Status quo graph:
```{r}


sim_geo_world_with_covid_data_statusquo <- function(){
  return(default_statusquo_simulation_data)
}
get_status_quo_risk <- function(){
  #just all countries, but we'll only get expected cases from NZ Residents
  status_quo_risk <- 
    sim_geo_world_with_covid_data_statusquo() %>%
    mutate(
      InterventionLevel=NA,
      InterventionLabel="None")# %>%
    # select(Location,
    #        ExpectedNumberOfCasesInCommunity,
    #        ExpectedCasesAtBorder
    # )
  return(status_quo_risk)
  }



status_quo_risk <- get_status_quo_risk()
status_quo_risk$Condition<-"Status Quo"

combined_risk_graph <- status_quo_risk
combined_risk_graph <- combined_risk_graph%>% filter(!is.na(ExpectedCasesAtBorder))

misc_countries_label <- "Other locations"

combined_risk_graph<- 
  combined_risk_graph %>% 
  mutate(LocationLabel = 
           case_when(
             (ExpectedCasesAtBorder<0.5) ~ misc_countries_label,
             TRUE ~ Location
           )) %>%
  arrange(desc(LocationLabel==misc_countries_label),ExpectedCasesAtBorder)



combined_risk_graph$LocationLabel <-
  factor(combined_risk_graph$LocationLabel,
         levels = unique(combined_risk_graph$LocationLabel),
         ordered=TRUE)

#combine across grouped categories
combined_risk_graph<-
  combined_risk_graph %>% 
  group_by(LocationLabel,Condition) %>%
  summarise(ExpectedCasesAtBorder=sum(ExpectedCasesAtBorder))# %>%
  #arrange(Condition,desc(LocationLabel))

#do the cumulative sum
combined_risk_graph <-
  combined_risk_graph %>%
  group_by(Condition) %>%
  arrange(LocationLabel==misc_countries_label,desc(ExpectedCasesAtBorder)) %>%
  #
  #arrange(desc(LocationLabel)) %>%
  mutate(LabelPosition=cumsum(ExpectedCasesAtBorder)-ExpectedCasesAtBorder/2)


combined_risk_graph <-
  combined_risk_graph %>%
  mutate(LocationAmountLabel = paste0(LocationLabel, "\n",signif(ExpectedCasesAtBorder,2)))

```

```{r}
get_colour_palette <- function(combined_risk_graph){
  location_labels_in_use <- length(unique(combined_risk_graph$LocationLabel))
  #create color palette
  color_palette<- c()
  if (misc_countries_label %in% combined_risk_graph$LocationLabel){
    color_palette <- c(color_palette ,'#555555')
  }
  color_palette = c(
    color_palette,
    rep(
      c('#1f78b4','#33a02c','#fb9a99','#e31a1c','#fdbf6f','#ff7f00','#6a3d9a','#b15928'),
      ceiling(location_labels_in_use/8))[1:location_labels_in_use]
  )
  return(color_palette)
}
color_palette <- get_colour_palette(combined_risk_graph)
```




```{r}



plot_max <- sum(combined_risk_graph$ExpectedCasesAtBorder)
ggplot(combined_risk_graph,aes(x=Condition,y=ExpectedCasesAtBorder,fill=LocationLabel,label=LocationAmountLabel
))+
  geom_bar(stat="identity",alpha=0.8)+
  scale_x_discrete(name="")+
  scale_y_continuous(name="Total Expected cases per month at border",
                     #breaks=0:plot_max,
                     limits = c(0,plot_max)#,
                     #limits=c(0,20),
                     #position="right"
  )+
  labs(title="Expected cases at the border each month by source country",
       caption="Simulation based on Statistics NZ arrival data in June 2020"
       )+
  scale_fill_manual(values = color_palette)+
  theme(legend.position = "none",legend.box="vertical",legend.margin=margin(),text=element_text(face = "bold"),
        axis.text = element_text(size=16)
  )+
  geom_label_repel(aes(y=LabelPosition),color="white",fontface="bold")+
  coord_flip()


```

What about expected cases in the community?


```{r}


combined_risk_graph <- status_quo_risk
combined_risk_graph <- combined_risk_graph%>% filter(!is.na(ExpectedNumberOfCasesInCommunity))
combined_risk_graph$ExpCasesInCommunityPerYear  <- combined_risk_graph$ExpectedNumberOfCasesInCommunity*12
misc_countries_label <- "Other locations"

combined_risk_graph<- 
  combined_risk_graph %>% 
  mutate(LocationLabel = 
           case_when(
             (ExpCasesInCommunityPerYear<0.1) ~ misc_countries_label,
             TRUE ~ Location
           )) %>%
  arrange(desc(LocationLabel==misc_countries_label),ExpCasesInCommunityPerYear)



combined_risk_graph$LocationLabel <-
  factor(combined_risk_graph$LocationLabel,
         levels = unique(combined_risk_graph$LocationLabel),
         ordered=TRUE)

#combine across grouped categories
combined_risk_graph<-
  combined_risk_graph %>% 
  group_by(LocationLabel,Condition) %>%
  summarise(ExpCasesInCommunityPerYear=sum(ExpCasesInCommunityPerYear))# %>%
  #arrange(Condition,desc(LocationLabel))

#do the cumulative sum
combined_risk_graph <-
  combined_risk_graph %>%
  group_by(Condition) %>%
  arrange(LocationLabel==misc_countries_label,desc(ExpCasesInCommunityPerYear)) %>%
  #
  #arrange(desc(LocationLabel)) %>%
  mutate(LabelPosition=cumsum(ExpCasesInCommunityPerYear)-ExpCasesInCommunityPerYear/2)



combined_risk_graph <-
  combined_risk_graph %>%
  #mutate(LocationAmountLabel = paste0(LocationLabel, "\n",scales::percent(signif(ExpCasesInCommunityPerYear,2),accuracy = 1)))
  mutate(LocationAmountLabel = paste0(LocationLabel, "\n",signif(ExpCasesInCommunityPerYear,2)))


color_palette <- get_colour_palette(combined_risk_graph)
```

```{r}

plot_max <- sum(combined_risk_graph$ExpCasesInCommunityPerYear)
ggplot(combined_risk_graph,aes(x=Condition,y=ExpCasesInCommunityPerYear,fill=LocationLabel,label=LocationAmountLabel
))+
  geom_bar(stat="identity",alpha=0.8)+
  scale_x_discrete(name="")+
  scale_y_continuous(name="Cumulative number of cases released into the community per YEAR",
                     #breaks=0:plot_max,
                     #labels = scales::percent_format(),
                     limits = c(0,plot_max)#,
                     #limits=c(0,20),
                     #position="right"
  )+
  labs(title="Cumulative number of cases released into the community from quarantine per YEAR",
       caption="Simulation based on Statistics NZ arrival data in June 2020.\nIncludes cases escaping through the quarantine system and  quarantine and airport staff infection risk."
       )+
  scale_fill_manual(values = color_palette)+
  theme(legend.position = "none",legend.box="vertical",legend.margin=margin(),text=element_text(face = "bold"),
        axis.text = element_text(size=16)
  )+
  geom_label_repel(aes(y=LabelPosition),color="white",fontface="bold")+
  coord_flip()


```



now we want to show three figures on a single page; might be best to do it vertically, or maybe not.

we want:

 - Travelers coming in under status quo
 - Expected cases at border under status quo
 - expected cases entering the community under status quo.
 
 

```{r}


risk_graph <- status_quo_risk
risk_graph <- risk_graph%>% filter(!is.na(ExpectedNumberOfCasesInCommunity))

#StatusQuoMonthlyArrivals,ExpectedCasesAtBorder,ExpectedNumberOfCasesInCommunity
misc_countries_label <- "Other locations"

risk_graph<- 
  risk_graph %>% 
  mutate(LocationLabel = 
           case_when(
             (StatusQuoMonthlyArrivals<200) ~ misc_countries_label,
             TRUE ~ Location
           )) %>%
  arrange(desc(LocationLabel==misc_countries_label),StatusQuoMonthlyArrivals)



risk_graph$LocationLabel <-
  factor(risk_graph$LocationLabel,
         levels = unique(risk_graph$LocationLabel),
         ordered=TRUE)

#var_of_interest <- c("StatusQuoMonthlyArrivals","ExpectedCasesAtBorder","ExpectedNumberOfCasesInCommunity")

variable_df <- data.frame(
  var_of_interest = c("StatusQuoMonthlyArrivals","ExpectedCasesAtBorder","ExpectedNumberOfCasesInCommunity"),
  var_friendly_name = c("Monthly Arrivals (June 2020)","Expected Cases At Border","Expected Cases Reaching Community")
)

plots <- apply(variable_df,1,function(v_row){
  print(v_row)
  v<-v_row[["var_of_interest"]]
  v_friendly_name <- v_row[["var_friendly_name"]]
  combined_risk_graph <- 
    risk_graph%>% 
  group_by(LocationLabel,Condition) %>%
  summarise(MonthlyValueByCountry=sum(!!sym(v)),
            StatusQuoMonthlyArrivals=sum(StatusQuoMonthlyArrivals)
            )
  
  #do the cumulative sum
  
  combined_risk_graph <-
    combined_risk_graph %>%
    group_by(Condition) %>%
    #we will arrange by the same measure each time
    arrange(LocationLabel==misc_countries_label,desc(StatusQuoMonthlyArrivals)) %>%
    #but then need to position according to the values for the measure being shown
    mutate(LabelPosition=cumsum(MonthlyValueByCountry)-MonthlyValueByCountry/2)
  
  #if(sum(combined_risk_graph[v],na.rm = TRUE))
  number_format <- function(num){
    if(num<0.01){
      return("< 0.01")
    }else{
      return(as.character(signif(num,2)))
    }
  }
  combined_risk_graph <-
    combined_risk_graph %>%
    rowwise() %>%
    mutate(LocationAmountLabel = paste0(LocationLabel, "\n",number_format(MonthlyValueByCountry)))
  
  color_palette <- get_colour_palette(combined_risk_graph)
  plot_max <- sum(combined_risk_graph$MonthlyValueByCountry,na.rm = TRUE)

    
  return(ggplot(combined_risk_graph,aes(x=Condition,y=MonthlyValueByCountry,fill=LocationLabel,label=LocationAmountLabel
  ))+
    geom_bar(stat="identity",alpha=0.8)+
    scale_x_discrete(name="")+
    scale_y_continuous(name=paste("Cumulative",v_friendly_name),
                       #breaks=0:plot_max,
                       #labels = scales::percent_format(),
                       limits = c(0,plot_max)#,
                       #limits=c(0,20),
                       #position="right"
    )+
    labs(title=v_friendly_name)+
    scale_fill_manual(values = color_palette)+
    theme(legend.position = "none",legend.box="vertical",legend.margin=margin(),text=element_text(face = "bold"),
          axis.text = element_text(size=16)
    )+
    geom_label_repel(aes(y=LabelPosition),color="white",fontface="bold")+
    coord_flip())

})




```

```{r}

library("cowplot")
plot_grid(plots[[1]], plots[[2]], plots[[3]], 
          labels = c(""),
          ncol = 1, nrow = 3)

```



Let's take a look at the status quo vs. New Zealand border rate


```{r}


nogeo_world_basic_data <- get_geomapped_covid_data(life_exp_thresh,run_date,separate_aussie_states_and_hk = TRUE,include_geo_data = FALSE)
default_simulation_data <- simulate_treatment_for_countries(
  nogeo_world_basic_data,
  treatment_effectiveness = default_assumed_effectiveness,
  extra_spread = 0,
  assumed_ifr = default_assumed_ifr_percent/100,
  traveler_relative_prevalence=default_traveler_relative_prevalence,
  current_lockdown_passenger_volume = default_current_lockdown_passenger_volume)
```
```{r}
default_statusquo_simulation_data <- simulate_treatment_for_countries(
  nogeo_world_basic_data,
  treatment_effectiveness = 99.95/100, 
    #should really be 99.9; 99.95 incorporates possiblity of a pre-departure test
    #still, it's "extra spread" that does most of the work here.
  extra_spread = 2.033/100,
  travel_volume_proportion=0,
  assumed_ifr = 0.6/100,
  traveler_relative_prevalence=1.2,
  current_lockdown_passenger_volume = 9037)
```



# Status quo graph

```{r}
run_date<-as.Date("2020-08-01")
month_name <- format(run_date,"%B")

nogeo_world_basic_data_july <- get_geomapped_covid_data(life_exp_thresh,run_date,separate_aussie_states_and_hk = TRUE,include_geo_data = FALSE)

default_statusquo_simulation_data_july <- simulate_treatment_for_countries(
  nogeo_world_basic_data_july,
  treatment_effectiveness = 99.95/100, 
    #should really be 99.9; 99.95 incorporates possiblity of a pre-departure test
    #still, it's "extra spread" that does most of the work here.
  extra_spread = 2.033/100,
  travel_volume_proportion=0,
  assumed_ifr = 0.6/100,
  traveler_relative_prevalence=1,
  current_lockdown_passenger_volume = 9037)
```



Status quo graph:


```{r}


sim_geo_world_with_covid_data_statusquo <- function(){
  return(default_statusquo_simulation_data_july)
}
get_status_quo_risk <- function(){
  #just all countries, but we'll only get expected cases from NZ Residents
  status_quo_risk <- 
    sim_geo_world_with_covid_data_statusquo() %>%
    mutate(
      InterventionLevel=NA,
      InterventionLabel="None")# %>%
    # select(Location,
    #        ExpectedNumberOfCasesInCommunity,
    #        ExpectedCasesAtBorder
    # )
  return(status_quo_risk)
  }



status_quo_risk <- get_status_quo_risk()
status_quo_risk$Condition<-"Status Quo"

combined_risk_graph <- status_quo_risk
combined_risk_graph <- combined_risk_graph%>% filter(!is.na(ExpectedCasesAtBorder))

misc_countries_label <- "Other locations"

combined_risk_graph<- 
  combined_risk_graph %>% 
  mutate(LocationLabel = 
           case_when(
             (ExpectedCasesAtBorder<0.5) ~ misc_countries_label,
             TRUE ~ Location
           )) %>%
  arrange(desc(LocationLabel==misc_countries_label),ExpectedCasesAtBorder)



combined_risk_graph$LocationLabel <-
  factor(combined_risk_graph$LocationLabel,
         levels = unique(combined_risk_graph$LocationLabel),
         ordered=TRUE)

#combine across grouped categories
combined_risk_graph<-
  combined_risk_graph %>% 
  group_by(LocationLabel,Condition) %>%
  summarise(ExpectedCasesAtBorder=sum(ExpectedCasesAtBorder))# %>%
  #arrange(Condition,desc(LocationLabel))

#do the cumulative sum
combined_risk_graph <-
  combined_risk_graph %>%
  group_by(Condition) %>%
  arrange(LocationLabel==misc_countries_label,desc(ExpectedCasesAtBorder)) %>%
  #
  #arrange(desc(LocationLabel)) %>%
  mutate(LabelPosition=cumsum(ExpectedCasesAtBorder)-ExpectedCasesAtBorder/2)


combined_risk_graph <-
  combined_risk_graph %>%
  mutate(LocationAmountLabel = paste0(LocationLabel, "\n",signif(ExpectedCasesAtBorder,2)))

```






```{r}

scale_y_breaks<- c(0,10,20,30,35,40)
scale_y_text<- c("0","10","20","30","\n Active cases\nreported returning\nJuly 2020","40")

plot_max <- sum(combined_risk_graph$ExpectedCasesAtBorder)
ggplot(combined_risk_graph,aes(x=Condition,y=ExpectedCasesAtBorder,fill=LocationLabel,label=LocationAmountLabel
))+
  geom_bar(stat="identity",alpha=0.8)+
  scale_x_discrete(name="")+
  scale_y_continuous(name="Total Expected cases in July 2020 at border",
                     breaks=scale_y_breaks,labels = scale_y_text,
                     limits = c(0,40)#,
                     #limits=c(0,20),
                     #position="right"
  )+
  geom_hline(yintercept = 35,linetype="dashed")+
  labs(title="Expected cases at the border in July 2020 by source country",
       caption="Simulation based on Statistics NZ arrival data in June 2020"
       )+
  scale_fill_manual(values = color_palette)+
  theme(legend.position = "none",legend.box="vertical",legend.margin=margin(),text=element_text(face = "bold"),
        axis.text = element_text(size=16)
  )+
  geom_label_repel(aes(y=LabelPosition),color="white",fontface="bold")+
  coord_flip()


```